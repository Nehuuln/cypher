<div class="home">
  <h2>Fil d'actualité</h2>
  <div *ngIf="loading">Chargement...</div>
  <div *ngIf="error" class="error">{{ error }}</div>

  <div *ngFor="let p of posts" class="post">
    <div class="author-line">
      <img *ngIf="p.author" [src]="avatarUrl(p.author)" alt="avatar" class="avatar" crossorigin="use-credentials" (error)="$event.target.style.display='none'" />
      <div class="author-meta"><strong>{{ p.author?.username }}</strong> — {{ p.createdAt | date:'short' }}</div>
    </div>

    <div class="text">{{ p.text }}</div>

    <div *ngIf="p.media">
      <img *ngIf="p.media.kind === 'image'" [src]="mediaUrl(p)" crossorigin="use-credentials" style="max-width:400px" />
      <video *ngIf="p.media.kind === 'video'" [src]="mediaUrl(p)" controls style="max-width:400px"></video>
    </div>

    <div class="post-actions" style="margin-top:8px">
      <button (click)="toggleLike(p)" [disabled]="likeProcessing[p._id]">
        {{ isLikedByMe(p) ? '♥️ Unlike' : '♡ Like' }}
      </button>
      <span style="margin-left:8px">{{ p.likesCount ?? (p.likes?.length || 0) }} like{{ (p.likesCount ?? (p.likes?.length || 0)) > 1 ? 's' : '' }}</span>
    </div>

    <div class="comments" style="margin-top:8px">
      <div style="display:flex; align-items:center; gap:8px;">
        <button (click)="openComments(p)">Commentaires ({{ (p.comments?.length || 0) }})</button>
        <span *ngIf="p.comments?.length">Dernier: {{ p.comments[p.comments.length-1]?.author?.username || '...' }} • {{ p.comments[p.comments.length-1]?.createdAt | date:'short' }}</span>
      </div>
    </div>
  </div>
</div>

<div *ngIf="selectedPostForComments" class="comments-modal-overlay" (click)="closeComments()" style="position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:1000;">
  <div class="comments-modal" (click)="$event.stopPropagation()" style="background:#fff;padding:16px;border-radius:6px;max-width:800px;width:95%;max-height:80vh;overflow:auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <div><strong>Commentaires</strong> — <small>{{ selectedPostForComments?.author?.username }}</small></div>
      <div><button (click)="closeComments()">Fermer</button></div>
    </div>

    <div style="border-top:1px solid #eee;padding-top:8px;">
      <div *ngIf="(selectedPostForComments?.comments || []).length === 0">Aucun commentaire</div>
      <div *ngFor="let c of sortedComments(selectedPostForComments)" style="padding:8px 0;border-bottom:1px solid #f2f2f2;">
        <div style="font-size:0.95rem;"><strong>{{ c.author?.username || 'Unknown' }}</strong> <small style="color:#666">• {{ c.createdAt | date:'short' }}</small></div>
        <div style="margin-top:4px">{{ c.text }}</div>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;align-items:flex-start;">
      <textarea rows="3" [(ngModel)]="newComment[selectedPostForComments._id]" name="modal-comment-{{selectedPostForComments._id}}" placeholder="Écrire un commentaire..." style="flex:1;padding:8px;"></textarea>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <button (click)="submitModalComment()" [disabled]="!newComment[selectedPostForComments._id]">Commenter</button>
      </div>
    </div>
  </div>
</div>