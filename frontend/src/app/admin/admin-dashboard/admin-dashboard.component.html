<div class="admin-dashboard page-content">
  <div class="admin-header">
    <h2>Tableau de bord</h2>
  </div>

  <div *ngIf="error" class="error-msg">{{ error }}</div>
  <div *ngIf="loading" class="loading-msg">Chargement des utilisateurs...</div>

  <div class="table-responsive" *ngIf="!loading && users.length">
    <table class="admin-table">
      <thead>
        <tr>
          <th>Utilisateur</th>
          <th>Rôles</th>
          <th>Contact</th>
          <th>ID Technique</th>
          <th>Action</th>
          <th>Ban</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let u of users" class="user-row">
          <td>
            <div class="user-cell">
              <img
                [src]="'https://localhost:3000/api/users/' + u._id + '/avatar'"
                alt="Avatar"
                class="admin-avatar"
                (error)="$event.target.style.display = 'none'"
              />
              <div class="user-info">
                <span class="user-name">{{ u.username }}</span>
                <span class="user-tag">@{{ u.tag }}</span>
              </div>
            </div>
          </td>

          <td>
            <div class="roles-wrapper" role="button" tabindex="0" title="Cliquer pour basculer admin/user" (click)="toggleRole(u)">
              <span
                *ngFor="let role of u.roles"
                class="role-badge"
                [class.admin]="role === 'admin'"
              >
                {{ role | uppercase }}
              </span>
            </div>
          </td>

          <td class="email-cell">{{ u.email }}</td>

          <td class="id-cell" title="{{ u._id }}">{{ u._id }}</td>

          <td>
            <a
              [routerLink]="['/profil/user/tag', u.tag]"
              title="Voir le profil"
              class="icon-action"
            >
              <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                <path
                  d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 11a4 4 0 1 1 .001-8.001A4 4 0 0 1 12 16zm0-6a2 2 0 1 0 .001 4.001A2 2 0 0 0 12 10z"
                />
              </svg>
            </a>

          </td>

          <td>
            <button
              *ngIf="!(u.roles || []).includes('admin')"
              class="action-btn outline"
              style="padding:8px 12px;font-size:12px;"
              (click)="openBanModal(u)"
            >
              {{ isBanned(u) ? 'Lever ban' : 'Bannir' }}
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="!loading && users.length === 0" class="empty-state">Aucun utilisateur trouvé.</div>
</div>

<!-- Modal Ban -->
<div *ngIf="banModalOpen" class="modal-overlay ban-modal" (click)="closeBanModal()">
  <div class="modal ban-modal-content" (click)="$event.stopPropagation()">
    <h3>Bannir un utilisateur</h3>
    <p *ngIf="banTarget">Cible : <strong>{{ banTarget.username }}</strong> (@{{ banTarget.tag }})</p>

    <div class="ban-form">
      <label>Durée (minutes, 0 pour lever le ban)</label>
      <input type="number" min="0" [(ngModel)]="banMinutes" />
      <label>Raison (optionnelle)</label>
      <textarea [(ngModel)]="banReason" rows="3"></textarea>
    </div>

    <div *ngIf="banError" class="error-msg ban-error">{{ banError }}</div>

    <div class="ban-actions">
      <button class="btn-secondary" (click)="closeBanModal()" [disabled]="banLoading">Annuler</button>
      <button class="btn-primary" (click)="submitBan()" [disabled]="banLoading">
        {{ banLoading ? 'En cours...' : 'Valider' }}
      </button>
    </div>
  </div>
</div>
